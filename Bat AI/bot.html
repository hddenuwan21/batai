<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BAT AI</title>
    <style>
        /* Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }


        :root {
            --primary: rgba(230, 230, 230, 0.8);
            --secondary: rgba(12, 13, 14, 0.8);
            --glass: rgba(255, 255, 255, 0.15);
            --glass-border: rgba(255, 255, 255, 0.25);
            --glass-highlight: rgba(255, 255, 255, 0.3);
            --text: rgba(255, 255, 255, 0.9);
            --text-light: rgba(255, 255, 255, 0.7);
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            --backdrop-blur: blur(5px);
            --transition: all 0.3s ease-out;
            --user-bubble: rgba(110, 72, 170, 0.8);
            --bot-bubble: rgba(240, 242, 245, 0.9);
            --bot-text: #1f1f1f;
            --code-bg: #282c34;
            --code-text: #abb2bf;


        }

        body {
            background: url(t.jpg) no-repeat center center fixed;
            background-size: cover;
            color: var(--text);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow-x: hidden;
            padding-top: calc(var(--header-height) + 20px);
        }

        /* Header Styles */
        header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: var(--header-height);
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: var(--backdrop-blur);
            -webkit-backdrop-filter: var(--backdrop-blur);
            border-bottom: 1px solid var(--glass-border);
            color: white;
            box-shadow: var(--shadow);
            z-index: 1000;
            transition: var(--transition);
            display: flex;
            flex-direction: column;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            height: var(--header-height);
            width: 100%;
        }



        .logo-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .avatar-container {
            position: relative;
            width: 50px;
            height: 50px;
        }

        .avatar {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(110, 72, 170, 0.4);
            position: relative;
        }

        .avatar img {
            width: 80%;
            height: 80%;
            object-fit: cover;
        }

        .avatar-pulse {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border: 3px solid rgba(0, 255, 255, 0.7);
            border-radius: 50%;
            animation: pulse 1.5s infinite cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 0;
        }

        .avatar-pulse:nth-child(2) {
            animation-delay: 0.5s;
        }

        @keyframes pulse {
            0% {
                transform: scale(0.5);
                opacity: 0.5;
                border-color: rgba(255, 255, 255, 0.8);
            }

            40% {
                opacity: 0.8;
                border-color: rgba(255, 255, 255, 0.4);
            }

            70% {
                transform: scale(1);
                opacity: 0.3;
                border-color: rgba(255, 255, 255, 0);
            }

            100% {
                transform: scale(1.2);
                opacity: 0;
                border-color: rgba(255, 255, 255, 0);
            }
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 10px;
            /* This controls the space between the avatar and text */
        }


        .logo-text {
            font-size: 1.5rem;
            font-weight: 700;
            color: #fff;
            position: relative;
            font-family: 'Arial Black', sans-serif;
            text-transform: uppercase;
            letter-spacing: 1px;
            animation: whitePulse 2s ease-in-out infinite alternate;
            text-shadow: 0 0 2px rgba(0, 0, 0, 0.1);
        }

        @keyframes whitePulse {
            0% {
                text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
            }

            100% {
                text-shadow: 0 0 15px rgba(255, 255, 255, 0.8);
            }
        }


        /* Optional: Add a bat silhouette that flies across occasionally */


        /* Mobile Menu Button */
        /* Header Content */
        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            /* This pushes logo left and menu right */
            padding: 0 20px;
            height: var(--header-height);
            width: 100%;
            /* Ensure it spans full width */
        }

        /* Mobile Menu Button */
        .menu-toggle {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            color: white;
            font-size: 20px;
            cursor: pointer;
            display: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            backdrop-filter: var(--backdrop-blur);
            -webkit-backdrop-filter: var(--backdrop-blur);
            transition: var(--transition);
            margin-left: auto;
            /* Pushes button to the right */
            position: relative;
            /* For precise positioning if needed */
            z-index: 1001;
            /* Ensure it stays above other elements */
        }

        @media (max-width: 768px) {
            .menu-toggle {
                display: flex;
                /* Show only on mobile */
                align-items: center;
                justify-content: center;
            }
        }

        .menu-toggle:hover {
            background: var(--glass-highlight);
        }

        nav {
            transition: var(--transition);

            display: flex;


            margin-bottom: 10px;
        }



        nav ul {

            display: flex;
            list-style: none;
            margin: 0 auto;
            /* Center the ul */
            padding: 0;
            justify-content: center;
            /* Center the items */
            width: auto;
            /* Remove fixed width */


        }

        nav li {
            text-align: center;
            padding: 5px;
            /* Remove large padding */
            margin: 0 5px;
            /* Add small margin between items */
            margin-top: -40px;
        }

        nav a {
            color: var(--text);
            text-decoration: none;
            font-weight: 500;
            padding: 8px 16px;
            /* Slightly smaller padding */
            display: block;
            border-radius: 8px;
            transition: var(--transition);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        nav a:hover,
        nav a.active {
            background: rgba(255, 250, 250, 0.2);
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        /* Chat Container Styles */
        .chat-container {
            width: 100%;
            max-width: 1200px;

            height: calc(100vh - var(--header-height) - 40px);
            min-height: 500px;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(155, 33, 33, 0.2);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.3);
            position: relative;

            backdrop-filter: var(--backdrop-blur);
            -webkit-backdrop-filter: var(--backdrop-blur);
            z-index: 1;
            margin: 0 auto;
        }

        .chat-container::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg,
                    rgba(238, 238, 238, 0.1) 0%,
                    rgba(255, 255, 255, 0.1) 50%,
                    rgba(0, 0, 0, 0.1) 100%);
            transform: rotate(45deg);
            z-index: -1;
            animation: liquidFlow 20s infinite linear;
            background-size: 200% 200%;
        }

        @keyframes liquidFlow {
            0% {
                transform: rotate(45deg) translate(-10%, -10%);
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                transform: rotate(45deg) translate(10%, 10%);
                background-position: 0% 50%;
            }
        }

        .chat-header {
            color: rgb(255, 255, 255);
            padding: 1.2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 2;
            background: rgba(0, 0, 0, 0.1);
        }

        .header-content {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Add this to your existing CSS */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - var(--header-height) - 20px);
            position: relative;
        }

        .chat-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            background: var(--glass);
            /* Remove position: relative if it exists */
            overflow-y: scroll;
            scrollbar-width: none;
            /* Firefox */
            -ms-overflow-style: none;
        }

        .input-container {
            position: sticky;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 15px 20px;
            border-top: 1px solid rgba(221, 221, 221, 0.5);
            display: flex;
            gap: 15px;
            background: var(--glass);
            backdrop-filter: var(--backdrop-blur);
            -webkit-backdrop-filter: var(--backdrop-blur);
            z-index: 10;
        }

        /* Adjust the chat container height */
        .chat-container {
            height: 80vh;
            max-height: 120vh;
            margin-bottom: -50px;

            /* Remove fixed min-height */
        }


        .message {
            max-width: 80%;
            padding: 18px 20px;
            border-radius: 18px;
            font-size: 0.95rem;
            line-height: 1.6;
            position: relative;
            transition: transform 0.2s, opacity 0.2s;
            word-wrap: break-word;
        }

        .message.user-message {
            background: var(--user-bubble);
            color: white;
            align-self: flex-end;
            border-radius: 18px 18px 0 18px;
            box-shadow: 0 2px 8px rgba(172, 170, 170, 0.3);
        }

        .message.bot-message {
            background: var(--bot-bubble);
            color: var(--bot-text);
            align-self: flex-start;
            border-radius: 18px 18px 18px 0;
            box-shadow: 0 2px 8px rgba(185, 6, 6, 0.05);
        }

        .message.appearing {
            animation: messageAppear 0.3s ease-out forwards;
        }

        @keyframes messageAppear {
            from {
                transform: scale(0.8);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }


        /* Typing Indicator */
        .typing-indicator {
            background: var(--bot-bubble) !important;
            color: var(--bot-text) !important;
            padding: 12px 16px !important;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            border-radius: 18px 18px 18px 0;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--bot-text);
            display: inline-block;
            animation: typingAnimation 1.4s infinite ease-in-out;
        }


        .typing-dot:nth-child(1) {
            animation-delay: 0s;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }



        @keyframes typingAnimation {

            0%,
            60%,
            100% {
                transform: translateY(0);
                opacity: 0.6;
            }

            30% {
                transform: translateY(-5px);
                opacity: 1;
            }
        }

        /* Input Container */


        #user-input {
            flex: 1;
            padding: 12px 18px;
            border: 1px solid rgba(221, 221, 221, 0.7);
            border-radius: 25px;
            outline: none;
            transition: all 0.3s;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(5px);
            font-size: 0.95rem;
            transition: all 0.3s ease-out;
        }




        #user-input:focus {
            border-color: #ffffff;
            box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.5);
            animation: inputFocusPulse 1.5s ease-in-out infinite;
        }

        @keyframes inputFocusPulse {
            0% {
                box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.5);
            }

            50% {
                box-shadow: 0 0 0 7px rgba(255, 255, 255, 0.3);
            }

            100% {
                box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.5);
            }
        }

        #send-btn {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: var(--backdrop-blur);
            -webkit-backdrop-filter: var(--backdrop-blur);
            color: rgb(216, 209, 209);
            border: none;
            padding: 0;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        #send-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 3px 12px rgba(255, 255, 255, 0.9);
        }

        #send-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }


        #stop-btn {
            display: none;
            background: rgba(255, 0, 0, 0.7);
            color: white;
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 10px rgba(234, 102, 102, 0.3);
        }

        #stop-btn:hover {
            transform: scale(1.1);
            background: rgba(255, 0, 0, 0.8);
        }

        .file-upload-btn {
            background: none;
            border: 1px;
            color: #000000;
            background: rgba(255, 255, 255, 0.8);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.2s;
            width: 45px;
            height: 45px;
        }

        .file-upload-btn:hover {

            transform: scale(1.1);
            box-shadow: 0 3px 12px rgba(255, 255, 255, 0.3);
        }

        #file-input {
            display: none;
        }

        /* Message Content Styles */
        .message-image {
            max-width: 100%;
            max-height: 300px;
            border-radius: 10px;
            margin-top: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            object-fit: contain;
        }

        .message-code-container {
            position: relative;
            margin-top: 8px;
        }

        .message-code {
            background: var(--code-bg);
            color: var(--code-text);
            border-radius: 6px;
            padding: 12px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.85rem;
            overflow-x: auto;
            margin-top: 8px;

            max-height: 300px;
            overflow-y: auto;
        }

        .code-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .code-language {
            font-size: 0.7rem;
            color: #000000;
            background: rgba(255, 255, 255, 0.8);
            padding: 2px 6px;
            border-radius: 4px;
        }

        .code-actions {
            display: flex;
            gap: 5px;
        }

        .code-action-btn {
            background: rgba(255, 255, 255, 0.8);
            border: none;
            border-radius: 4px;
            padding: 2px 6px;
            font-size: 0.9rem;
            cursor: pointer;
            color: var(--code-text);
            transition: all 0.2s;
            color: #000000;
        }

        .code-action-btn:hover {
            background: rgba(0, 0, 0, 0.2);
        }

        .file-preview {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(102, 126, 234, 0.1);
            padding: 8px 12px;
            border-radius: 12px;
            margin-top: 8px;
            font-size: 0.85rem;
        }

        .file-icon {
            font-size: 1.2rem;
        }

        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 120px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -60px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.8rem;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .action-btn {
            background: rgba(102, 126, 234, 0.1);
            border: none;
            border-radius: 15px;
            padding: 5px 10px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .action-btn:hover {
            background: rgba(102, 126, 234, 0.2);
        }

        /* Emoji and Animation Styles */
        .message-emoji {
            font-size: 1.2rem;
            margin-right: 5px;
            vertical-align: middle;
        }

        .message-animation {
            display: inline-block;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {

            0%,
            20%,
            50%,
            80%,
            100% {
                transform: translateY(0);
            }

            40% {
                transform: translateY(-10px);
            }

            60% {
                transform: translateY(-5px);
            }
        }

        /* Responsive Styles */
        @media (max-width: 768px) {
            .logo-container {
                padding: 0 10px;
            }

            .menu-toggle {
                display: flex;
                align-items: center;
                justify-content: center;
            }

            nav {
                max-height: 0;
                overflow: hidden;
            }

            nav.active {
                max-height: 500px;
            }

            nav ul {
                flex-direction: column;
                margin-top: 10px;

            }

            nav li {
                margin: 5px 0;
                padding: 10px;
                color: #000000;

            }

            nav a {
                margin: 0;
                background: rgba(0, 0, 0, 0.25);
                ;

            }

            .chat-container {
                width: 100%;
                height: calc(85vh - 10px);
                margin-top: 30px;
                border-radius: 15px;
            }

            .chat-header {
                padding: 0.8rem;
            }

            .chat-body {
                padding: 15px;
            }

            .message {
                max-width: 90%;
                padding: 8px 12px;
                font-size: 0.85rem;
            }

            .input-container {
                padding: 10px;
            }

            #user-input {
                padding: 8px 12px;
                font-size: 0.85rem;
            }

            #send-btn,
            #stop-btn,
            .file-upload-btn {
                width: 40px;
                height: 40px;
            }

            .message-image {
                max-height: 200px;
            }
        }

        @media (max-width: 480px) {
            .message {
                max-width: 95%;
            }

            .message-image {
                max-height: 150px;
            }

            .input-container {
                gap: 5px;
            }

            #user-input {
                padding: 8px 12px;
            }

            #send-btn,
            #stop-btn,
            .file-upload-btn {
                width: 35px;
                height: 35px;
            }
        }



        /* Loading Animation */
        .loading-animation {
            display: inline-block;
            position: relative;
            width: 24px;
            height: 24px;
        }

        .loading-animation div {
            position: absolute;
            width: 6px;
            height: 6px;
            background: white;
            border-radius: 50%;
            animation: loading 1.2s linear infinite;
        }

        .loading-animation div:nth-child(1) {
            animation-delay: 0s;
            top: 12px;
            left: 0;
        }

        .loading-animation div:nth-child(2) {
            animation-delay: -0.4s;
            top: 4px;
            left: 4px;
        }

        .loading-animation div:nth-child(3) {
            animation-delay: -0.8s;
            top: 0;
            left: 12px;
        }

        .loading-animation div:nth-child(4) {
            animation-delay: -0.4s;
            top: 4px;
            right: 4px;
        }

        .loading-animation div:nth-child(5) {
            animation-delay: -0.8s;
            top: 12px;
            right: 0;
        }

        .loading-animation div:nth-child(6) {
            animation-delay: -1.2s;
            bottom: 4px;
            right: 4px;
        }

        .loading-animation div:nth-child(7) {
            animation-delay: -1.6s;
            bottom: 0;
            left: 12px;
        }

        .loading-animation div:nth-child(8) {
            animation-delay: -1.2s;
            bottom: 4px;
            left: 4px;
        }

        @keyframes loading {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.3;
            }
        }
    </style>
</head>

<body>
    <header>
        <div class="header-content">
            <div class="logo-container">
                <div class="avatar-container">
                    <div class="avatar-pulse"></div>
                    <div class="avatar-pulse"></div>
                    <div class="avatar">
                        <img src="e.png" alt="AI Girl Avatar">
                    </div>
                </div>
                <div class="logo-text">bat ai</div>
            </div>
            <button class="menu-toggle" id="menu-toggle">☰</button>
        </div>

        <nav id="main-nav">
            <ul>
                <li><a href="bot.html" class="active">AI Chat</a></li>
                <li><a href="image.html">Image Generate</a></li>
                <li><a href="#">Game</a></li>
                <li><a href="about.html">About</a></li>
            </ul>
        </nav>
    </header>

    <div class="chat-container">
        <div class="chat-header">
            <div class="header-content">
                <h3>BAT Assistant</h3>
            </div>
        </div>
        <div class="chat-body" id="chat-body">
            <div class="message bot-message appearing">
                <span class="message-emoji">👋</span>Hello! I'm 🤖BAT AI, your advanced AI assistant. I can help with
                text,💡
                code, images, and files. How can I assist you today?
            </div>
        </div>
        <div class="input-container">
            <input type="text" id="user-input" placeholder="Type your message..." autocomplete="off">
            <button class="tooltip file-upload-btn" id="file-upload-btn">
                📎
                <span class="tooltiptext">Upload file/image</span>
            </button>
            <input type="file" id="file-input"
                accept=".txt,.pdf,.doc,.docx,.jpg,.jpeg,.png,.gif,.c,.java,.html,.css,.js,.py,.cpp,.cs,.php,.rb,.go,.rs,.swift,.kt,.ts,.sh">
            <button id="stop-btn">⏹</button>
            <button id="send-btn">🦇</button>
        </div>
    </div>

    <script>
        // Toggle mobile menu
        const menuToggle = document.getElementById('menu-toggle');
        const mainNav = document.getElementById('main-nav');

        menuToggle.addEventListener('click', () => {
            mainNav.classList.toggle('active');
            menuToggle.textContent = mainNav.classList.contains('active') ? '✕' : '☰';
        });

        // Close menu when clicking on a link
        const navLinks = document.querySelectorAll('nav a');
        navLinks.forEach(link => {
            link.addEventListener('click', () => {
                if (window.innerWidth <= 768) {
                    mainNav.classList.remove('active');
                    menuToggle.textContent = '☰';
                }
            });
        });

        // Adjust header height on resize
        function adjustHeaderHeight() {
            const header = document.querySelector('header');
            const nav = document.querySelector('nav');
            if (window.innerWidth > 768) {
                header.style.height = 'auto';
            } else {
                header.style.height = nav.classList.contains('active') ? 'auto' : 'var(--header-height)';
            }
        }

        window.addEventListener('resize', adjustHeaderHeight);
        adjustHeaderHeight();

        // Chat functionality
        const chatBody = document.getElementById('chat-body');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const stopBtn = document.getElementById('stop-btn');
        const fileUploadBtn = document.getElementById('file-upload-btn');
        const fileInput = document.getElementById('file-input');

        // API Configuration
        const API_KEY = "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";
        const API_URL = "https://openrouter.ai/api/v1/chat/completions";
        const MODEL = "deepseek/deepseek-r1:free";

        // Conversation history
        let conversationHistory = [
            {
                role: "system",
                content: `You are BAT AI, a helpful AI assistant. Follow these response guidelines:
        
✅ 1. Use Clear Structure
• Add headings or titles (bold or caps) for topics
• Use paragraphs for clarity
• Bullet points or numbered lists for steps or features

✅ 2. Use Bold for Emphasis
• **Highlight** key points
• Use sparingly for maximum impact

✅ 3. Use Proper Language
• Adjust style for user (casual, formal, technical)
• Maintain professional but friendly tone

✅ 4. Code Formatting
• Use code blocks (\`\`\`) for code
• Specify language for syntax highlighting
• Include comments when helpful

✅ 5. Visual Indicators
• Use emojis to enhance readability
• Add dividers between sections when needed
• Format lists clearly with spacing

Be concise but thorough in responses.`
            }
        ];

        // Cache for faster responses
        let responseCache = {};
        let isWaitingForResponse = false;
        let abortController = null;

        // Function to detect code language from file extension
        function detectCodeLanguage(filename) {
            const extension = filename.split('.').pop().toLowerCase();
            const languageMap = {
                'js': 'JavaScript',
                'py': 'Python',
                'java': 'Java',
                'c': 'C',
                'cpp': 'C++',
                'cs': 'C#',
                'php': 'PHP',
                'rb': 'Ruby',
                'go': 'Go',
                'rs': 'Rust',
                'swift': 'Swift',
                'kt': 'Kotlin',
                'ts': 'TypeScript',
                'sh': 'Bash',
                'html': 'HTML',
                'css': 'CSS',
                'json': 'JSON',
                'xml': 'XML',
                'md': 'Markdown',
                'sql': 'SQL'
            };
            return languageMap[extension] || extension;
        }

        function addMessage(text, isUser = false, isFile = false, fileData = null) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', isUser ? 'user-message' : 'bot-message', 'appearing');

            if (isFile && fileData) {
                if (fileData.type.startsWith('image/')) {
                    messageDiv.innerHTML = `
                <div>${text}</div>
                <img src="${fileData.url}" class="message-image" alt="Uploaded image">
            `;
                } else {
                    messageDiv.innerHTML = `
                <div>${text}</div>
                <div class="file-preview">
                    <span class="file-icon">📄</span>
                    <span>${fileData.name}</span>
                </div>
            `;
                }
            } else if (text.includes('```')) {
                messageDiv.innerHTML = formatCodeInMessage(text);
            } else {
                messageDiv.innerHTML = processTextWithEmojis(text);
            }

            chatBody.appendChild(messageDiv);
            chatBody.scrollTop = chatBody.scrollHeight;

            messageDiv.querySelectorAll('.copy-btn').forEach(btn => {
                btn.addEventListener('click', copyCodeToClipboard);
            });

            messageDiv.querySelectorAll('.download-btn').forEach(btn => {
                btn.addEventListener('click', downloadCode);
            });

            setTimeout(() => {
                messageDiv.classList.remove('appearing');
            }, 300);
        }

        function processTextWithEmojis(text) {
            // Expanded emoji mapping
            const emojiMap = {
                ':)': '😊', ':(': '😞', ':D': '😃', ';)': '😉',
                ':P': '😛', ':O': '😮', '<3': '❤️', ':/': '😕',
                ':*': '😘', ':|': '😐', '>:(': '😠', ':\'(': '😢',
                'XD': '😆', 'B)': '😎', 'o.O': '😳', 'O.o': '😲',
                ':*': '😗', ':-*': '😙', '>:)': '😈', '>:D': '👿',
                ':thumbsup:': '👍', ':thumbsdown:': '👎', ':wave:': '👋',
                ':clap:': '👏', ':muscle:': '💪', ':pray:': '🙏'
            };

            let processedText = text;
            for (const [key, value] of Object.entries(emojiMap)) {
                processedText = processedText.replace(new RegExp(escapeRegExp(key), 'g'), value);
            }

            return processedText.replace(/([\u{1F600}-\u{1F64F}]|[\u{1F300}-\u{1F5FF}]|[\u{1F680}-\u{1F6FF}]|[\u{1F700}-\u{1F77F}]|[\u{1F780}-\u{1F7FF}]|[\u{1F800}-\u{1F8FF}]|[\u{1F900}-\u{1F9FF}]|[\u{1FA00}-\u{1FA6F}]|[\u{1FA70}-\u{1FAFF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}])/gu,
                match => `<span class="message-emoji message-animation">${match}</span>`);
        }

        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        function formatCodeInMessage(text) {
            const parts = text.split('```');
            let html = '';
            let isCodeBlock = false;
            let currentLanguage = '';

            for (let i = 0; i < parts.length; i++) {
                if (isCodeBlock) {
                    const firstLineBreak = parts[i].indexOf('\n');
                    if (firstLineBreak !== -1) {
                        const potentialLang = parts[i].substring(0, firstLineBreak).trim();
                        if (potentialLang) {
                            currentLanguage = potentialLang;
                            parts[i] = parts[i].substring(firstLineBreak + 1);
                        }
                    }

                    html += `
                <div class="message-code-container">
                    <div class="code-toolbar">
                        <span class="code-language">${currentLanguage || 'code'}</span>
                        <div class="code-actions">
                            <button class="code-action-btn copy-btn" data-code="${escapeHtml(parts[i])}">Copy</button>
                            <button class="code-action-btn download-btn" data-code="${escapeHtml(parts[i])}" data-lang="${currentLanguage || 'txt'}">Download</button>
                        </div>
                    </div>
                    <pre class="message-code">${escapeHtml(parts[i])}</pre>
                </div>
            `;
                    currentLanguage = '';
                } else {
                    html += parts[i].replace(/\n/g, '<br>');
                }
                isCodeBlock = !isCodeBlock;
            }

            return html;
        }

        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function copyCodeToClipboard(event) {
            const code = event.target.getAttribute('data-code');
            navigator.clipboard.writeText(code).then(() => {
                const originalText = event.target.textContent;
                event.target.textContent = 'Copied!';
                setTimeout(() => {
                    event.target.textContent = originalText;
                }, 2000);
            });
        }

        function downloadCode(event) {
            const code = event.target.getAttribute('data-code');
            const lang = event.target.getAttribute('data-lang');
            const extension = getFileExtension(lang);
            const filename = `code.${extension}`;

            const blob = new Blob([code], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function getFileExtension(language) {
            const extensionMap = {
                'javascript': 'js',
                'python': 'py',
                'java': 'java',
                'c': 'c',
                'c++': 'cpp',
                'c#': 'cs',
                'php': 'php',
                'ruby': 'rb',
                'go': 'go',
                'rust': 'rs',
                'swift': 'swift',
                'kotlin': 'kt',
                'typescript': 'ts',
                'bash': 'sh',
                'html': 'html',
                'css': 'css',
                'json': 'json',
                'xml': 'xml',
                'markdown': 'md',
                'sql': 'sql'
            };
            return extensionMap[language.toLowerCase()] || 'txt';
        }

        function showTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.classList.add('message', 'bot-message', 'typing-indicator');
            typingDiv.id = 'typing-indicator';
            typingDiv.innerHTML = `
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
    `;
            chatBody.appendChild(typingDiv);
            chatBody.scrollTop = chatBody.scrollHeight;
        }

        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }
        // ... (keep all the existing code until the getAIResponse function)




        async function getAIResponse(userMessage, fileContent = null) {
            if (isWaitingForResponse) {
                addMessage("Please wait for my current response to complete.", false);
                return;
            }

            isWaitingForResponse = true;
            sendBtn.style.display = 'none';
            stopBtn.style.display = 'flex';
            abortController = new AbortController();

            // Show typing indicator immediately
            showTypingIndicator();

            const cacheKey = userMessage + (fileContent ? JSON.stringify(fileContent) : '');
            if (responseCache[cacheKey]) {
                hideTypingIndicator();
                addMessage(responseCache[cacheKey], false);
                completeResponse();
                return;
            }

            // Enhanced system prompt with response formatting guidelines
            const enhancedSystemPrompt = `You are BAT AI, a helpful AI assistant. Follow these response guidelines:

1. INTENT UNDERSTANDING
- Always clarify the user's intent by paraphrasing if needed
- Ensure you fully understand the request before responding

2. RESPONSE STRUCTURE
Use this format when appropriate:
[Optional Heading]
📌 **Introduction/Explanation**: Brief context
🔹 **Main Content**: 
  - Bullet points or numbered steps
  - Code blocks when needed (with language specification)
  - Tables for comparison data
💡 **Summary/Next Steps**: Key takeaways or suggested actions

3. TEMPLATES FOR COMMON QUERIES:
• Code Help: Explanation → Code Example → Output
• Diagram Requests: Description → ASCII Art → Notes
• Concepts: Definition → Key Points → Applications

4. STYLING:
- Use **bold** for emphasis
- Use *italics* for subtle emphasis
- Use emojis sparingly for visual cues
- Always format code properly with syntax highlighting

Be concise but thorough. Adjust tone based on user's style.`;

            const messages = [
                { role: "system", content: enhancedSystemPrompt },
                ...conversationHistory.slice(1) // Keep previous conversation but replace system prompt
            ];

            if (fileContent) {
                if (fileContent.type.startsWith('image/')) {
                    messages.push({
                        role: "user",
                        content: [
                            { type: "text", text: userMessage },
                            { type: "image_url", image_url: { url: fileContent.url } }
                        ]
                    });
                } else {
                    messages.push({
                        role: "user",
                        content: userMessage + `\n[Attached file: ${fileContent.name}]`
                    });
                }
            } else {
                messages.push({ role: "user", content: userMessage });
            }

            try {
                const response = await fetch(API_URL, {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${API_KEY}`,
                        "Content-Type": "application/json",
                        "HTTP-Referer": window.location.href,
                        "X-Title": "BAT AI"
                    },
                    body: JSON.stringify({
                        model: MODEL,
                        messages: messages,
                        temperature: 0.7,
                        max_tokens: 2000,
                        stream: true
                    }),
                    signal: abortController.signal
                });

                if (!response.ok) throw new Error(`API request failed with status ${response.status}`);

                // Create message container after we know the request is successful
                hideTypingIndicator();
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('message', 'bot-message');
                chatBody.appendChild(messageDiv);

                let fullResponse = '';
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let codeBlockBuffer = '';
                let inCodeBlock = false;

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop();

                    for (const line of lines) {
                        if (line.startsWith('data:') && !line.includes('[DONE]')) {
                            try {
                                const data = JSON.parse(line.substring(5));
                                const token = data.choices[0]?.delta?.content || '';

                                fullResponse += token;

                                // Enhanced formatting for structured responses
                                if (token.includes('```') || inCodeBlock) {
                                    codeBlockBuffer += token;
                                    inCodeBlock = (codeBlockBuffer.match(/```/g) || []).length % 2 !== 0;

                                    if (!inCodeBlock && codeBlockBuffer) {
                                        messageDiv.innerHTML = formatEnhancedResponse(processTextWithEmojis(fullResponse));
                                        codeBlockBuffer = '';
                                    }
                                } else {
                                    messageDiv.innerHTML = formatEnhancedResponse(processTextWithEmojis(fullResponse));
                                }

                                chatBody.scrollTop = chatBody.scrollHeight;
                            } catch (e) {
                                console.error('Error parsing stream data:', e);
                            }
                        }
                    }
                }

                // Final formatting pass
                messageDiv.innerHTML = formatEnhancedResponse(processTextWithEmojis(fullResponse));

                responseCache[cacheKey] = fullResponse;
                conversationHistory.push(
                    { role: "user", content: userMessage + (fileContent ? `\n[Attached file: ${fileContent.name}]` : '') },
                    { role: "assistant", content: fullResponse }
                );

            } catch (error) {
                hideTypingIndicator();
                if (error.name !== 'AbortError') {
                    addMessage("Sorry, I encountered an error. Please try again later.", false);
                    console.error("Error:", error);
                }
            } finally {
                completeResponse();
            }

            function completeResponse() {
                isWaitingForResponse = false;
                sendBtn.style.display = 'flex';
                stopBtn.style.display = 'none';
                abortController = null;

                document.querySelectorAll('.copy-btn').forEach(btn => {
                    btn.addEventListener('click', copyCodeToClipboard);
                });
                document.querySelectorAll('.download-btn').forEach(btn => {
                    btn.addEventListener('click', downloadCode);
                });
            }
        }

        // Enhanced response formatting function
        function formatEnhancedResponse(text) {
            // Format headings
            text = text.replace(/^(#+)\s*(.*?)\s*$/gm, (match, hashes, content) => {
                const level = hashes.length;
                return `<h${level} style="margin: 10px 0 5px 0; font-weight: bold; font-size: ${1.2 - (level * 0.1)}rem;">${content}</h${level}>`;
            });

            // Format bullet points and numbered lists
            text = text.replace(/^(\s*[-*•])\s+(.*)/gm, '<li>$2</li>');
            text = text.replace(/^(\s*\d+\.)\s+(.*)/gm, '<li>$2</li>');

            // Wrap lists in proper HTML
            text = text.replace(/(<li>.*<\/li>)+/g, (match) => {
                return `<ul style="margin: 8px 0; padding-left: 20px;">${match}</ul>`;
            });

            // Format bold and italics
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');

            // Format code blocks (handled separately in formatCodeInMessage)
            if (text.includes('```')) {
                return formatCodeInMessage(text);
            }

            // Format tables (basic support)
            text = text.replace(/\|(.+?)\|/g, (match) => {
                const cells = match.split('|').filter(cell => cell.trim() !== '');
                if (cells.length > 1) {
                    if (cells[0].includes('-')) {
                        return ''; // Skip separator rows for now
                    }
                    return `<tr>${cells.map(cell => `<td style="padding: 3px 8px; border: 1px solid rgba(255,255,255,0.2);">${cell.trim()}</td>`).join('')}</tr>`;
                }
                return match;
            });

            // Wrap tables in table tags if we find pipe syntax
            if (text.includes('<tr>')) {
                text = text.replace(/(<tr>.*<\/tr>)+/g, (match) => {
                    return `<table style="margin: 10px 0; border-collapse: collapse;">${match}</table>`;
                });
            }

            // Format paragraphs
            text = text.split('\n\n').map(para => {
                if (!para.startsWith('<') && !para.match(/^<[a-z]/i)) {
                    return `<p style="margin: 8px 0;">${para}</p>`;
                }
                return para;
            }).join('');

            return text;
        }






        // ... (keep all remaining existing code)
        // Event listeners
        sendBtn.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        fileUploadBtn.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', handleFileUpload);

        stopBtn.addEventListener('click', () => {
            if (abortController) {
                abortController.abort();
                hideTypingIndicator();
                isWaitingForResponse = false;
                sendBtn.style.display = 'flex';
                stopBtn.style.display = 'none';
                addMessage("Response stopped.", false);
            }
        });

        function sendMessage() {
            const message = userInput.value.trim();
            if (message && !isWaitingForResponse) {
                addMessage(message, true);
                userInput.value = '';
                getAIResponse(message);
            }
        }

        function handleFileUpload() {
            const file = fileInput.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                const fileData = {
                    name: file.name,
                    type: file.type,
                    size: file.size,
                    content: file.type.startsWith('text/') ? e.target.result : null,
                    url: file.type.startsWith('image/') ? URL.createObjectURL(file) : null
                };

                const message = `I've uploaded a file: ${file.name}`;
                addMessage(message, true, true, fileData);

                let contentForAI = `User uploaded a ${file.type} file named ${file.name}. `;
                if (file.type.startsWith('text/')) {
                    contentForAI += `Here's the content:\n${fileData.content.substring(0, 1000)}` +
                        (fileData.content.length > 1000 ? "\n[...truncated]" : "");
                } else if (file.type.startsWith('image/')) {
                    contentForAI += "Please analyze this image.";
                } else {
                    contentForAI += "Please process this file.";
                }

                getAIResponse(contentForAI, fileData);
            };

            if (file.type.startsWith('text/')) {
                reader.readAsText(file);
            } else if (file.type.startsWith('image/')) {
                reader.readAsDataURL(file);
            } else {
                const fileData = {
                    name: file.name,
                    type: file.type,
                    size: file.size,
                    content: null,
                    url: null
                };
                const message = `I've uploaded a file: ${file.name}`;
                addMessage(message, true, true, fileData);
                getAIResponse(`User uploaded a ${file.type} file named ${file.name}. Please process it.`, fileData);
            }

            fileInput.value = '';
        }

        // Initialize with welcome message
        if (chatBody.children.length === 0) {
            addMessage("👋 Hello! I'm BAT AI, your advanced AI assistant. How can I help you today?", false);
        }



    </script>
</body>

</html>